#!/usr/bin/env node

'use strict';


try {
    var Conkitty = require('../conkitty'),
        fs = require('fs'),
        path = require('path'),
        conkittyPath = path.dirname(require.resolve('../conkitty')),
        program = require('commander'),

        tplFilename,
        commonFilename,
        depsFilename;


    program
        .version(JSON.parse(fs.readFileSync(conkittyPath + '/package.json', {encoding: 'utf8'})).version)
        .usage('[options] <filename ...>')
        .option('-c, --common [filename]', 'File for common code')
        .option('-t, --templates [filename]', 'File for compiled templates code')
        .option('-d, --deps [filename]', 'File for dependencies declared inside templates')
        .parse(process.argv);

    tplFilename = program.templates;
    commonFilename = program.common;
    depsFilename = program.deps;

    if (!program.args.length) {
        console.log('No template files specified.');
    } else if (!tplFilename && !commonFilename && !depsFilename) {
        console.log('No output options specified.');
    } else {
        var conkitty = new Conkitty(),
            i,
            filename;

        for (i = 0; i < program.args.length; i++) {
            filename = path.resolve(program.args[i]);
            conkitty.push(fs.readFileSync(filename, {encoding: 'utf8'}), path.dirname(filename));
        }

        conkitty.generate();

        if (commonFilename) {
            fs.writeFileSync(commonFilename, conkitty.getCommonCode());
            console.log('File "' + commonFilename + '" created.');
        }

        if (tplFilename) {
            fs.writeFileSync(tplFilename, conkitty.getTemplatesCode());
            console.log('File "' + tplFilename + '" created.');
        }

        if (depsFilename) {
            fs.writeFileSync(depsFilename, conkitty.getIncludes().join('\n'));
            console.log('File "' + depsFilename + '" created.');
        }
    }
} catch(e) {
    console.log(e.message);
    process.exit(1);
}
